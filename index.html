<!doctype HTML>
<html>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<script src="js/aframe.min.js"></script>
<script src="js/aframe-ar.js"></script>
<body style="margin: 0px; overflow: hidden;">

<script>

// access underlying 3D object this component is attached to
AFRAME.registerComponent('spinner', {

	init: function()
	{
		this.el.object3D.scale.set(1.5, 1.5, 1.5);
        this.line = document.querySelector('#line-to-zurich');
	},
	
	tick: function (time, timeDelta) 
	{
		//this.el.object3D.rotation.y += 0.01

        const latitude = 47.3769; // Zurich's latitude
        const longitude = 8.5417; // Zurich's longitude
        let globeRotationY = this.el.object3D.rotation.y;
        let endPoint = this.calculateEndPoint(latitude, longitude, globeRotationY);
        // Ensure we're updating the line component correctly
        this.line.setAttribute('line', `start: 0 2.7 0; end: ${endPoint.x} ${endPoint.y} ${endPoint.z}; color: red`);
	},

    calculateEndPoint: function(latitude, longitude, globeRotationY) {
        const globeScale = 1.5; // Adjust as necessary
        const radius = 1.5; // Globe's radius adjusted for scale
        const globeCenterY = 0.5; // Globe's center Y position

        // Convert latitude and longitude to radians
        const latRad = Math.PI / 2 - THREE.Math.degToRad(latitude);
        const lonRad = THREE.Math.degToRad(longitude) - globeRotationY - 0.302;

        // Spherical to Cartesian conversion
        const x = radius * Math.sin(latRad) * Math.cos(lonRad);
        const y = globeCenterY + radius * Math.cos(latRad);
        const z = radius * Math.sin(latRad) * Math.sin(lonRad);

        return { x: x, y: y, z: z };
    }

});

AFRAME.registerComponent("gesture-handler", {
    schema: {
        enabled: { default: true },
        rotationFactor: { default: 5 },
    },

    init: function () {
        this.handleRotation = this.handleRotation.bind(this);

        this.isVisible = false;

        this.el.sceneEl.addEventListener("markerFound", (e) => {
          this.isVisible = true;
        });

        this.el.sceneEl.addEventListener("markerLost", (e) => {
          this.isVisible = false;
        });
    },

    update: function () {
        if (this.data.enabled) {
            this.el.sceneEl.addEventListener("onefingermove", this.handleRotation);
        } else {
            this.el.sceneEl.removeEventListener("onefingermove", this.handleRotation);
        }
    },

    remove: function () {
        this.el.sceneEl.removeEventListener("onefingermove", this.handleRotation);
    },

    handleRotation: function (event) {
        if (this.isVisible) {
            this.el.object3D.rotation.y +=
                event.detail.positionChange.x * this.data.rotationFactor;
            // this.el.object3D.rotation.x +=
            //     event.detail.positionChange.y * this.data.rotationFactor;
        }
    }
});
</script>


<a-scene embedded vr-mode-ui="enabled: false;" renderer="logarithmicDepthBuffer: true"arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;' gesture-detector>

    <a-assets>
		<img id="earth-sphere" src="images/earth-sphere.jpg" />
	</a-assets>
    
    <a-marker
        type="barcode"
        value="6"
        raycaster="objects: .clickable"
        emitevents="true"
        cursor="fuse: false; rayOrigin: mouse;"
    >
        <a-sphere 
           id="earth"
           position="0 0.5 0"
           rotation="0 100 0"
           material="src: #earth-sphere; transparent: true; opacity: 0.95;"
           class="clickable"
           gesture-handler>
        </a-sphere>

        <!-- Adding Irchel Campus text in red -->
        <a-text value="Campus Irchel"
            color="red"
            position="0 3 0"
            align="center"
            width="6">
        </a-text>

        <!-- Drawing a red line pointing to Zurich -->
        <a-entity id="line-to-zurich" line="start: 0 2.7 0; end: 1.004, 1.604, -0.151; color: red"></a-entity>
    </a-marker>
    
    <a-entity camera></a-entity>
    
    
</a-scene>
</body>
</html>